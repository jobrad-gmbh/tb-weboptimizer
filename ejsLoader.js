#!/usr/bin/env node
// -*- coding: utf-8 -*-
'use strict';
/* !
    region header
    Copyright Torben Sickert (info["~at~"]torben.website) 16.12.2012

    License
    -------

    This library written by Torben Sickert stand under a creative commons
    naming 3.0 unported license.
    See https://creativecommons.org/licenses/by/3.0/deed.de
    endregion
*/
// region imports

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _core = require("@babel/core");

var _babelPresetMinify = _interopRequireDefault(require("babel-preset-minify"));

var _clientnode = _interopRequireDefault(require("clientnode"));

var _ejs = _interopRequireDefault(require("ejs"));

var _fs = _interopRequireDefault(require("fs"));

var _htmlMinifier = require("html-minifier");

var loaderUtils = _interopRequireWildcard(require("loader-utils"));

var _path = _interopRequireDefault(require("path"));

var _configurator = _interopRequireDefault(require("./configurator"));

var _helper = _interopRequireDefault(require("./helper"));

/*
    NOTE: Would result in error: "TypeError:
    ../webOptimizer/unknown: Cannot read property
    'contextVariables' of undefined

    import transformWith from 'babel-plugin-transform-with'
*/
// endregion
module.exports = function (source) {
  var _this = this;

  if ('cachable' in this && this.cacheable) this.cacheable();

  var query = _clientnode["default"].convertSubstringInPlainObject(_clientnode["default"].extend(true, {
    compileSteps: 2,
    compress: {
      html: {},
      javaScript: {}
    },
    context: './',
    extensions: {
      file: {
        external: [],
        internal: ['.js', '.json', '.css', '.svg', '.png', '.jpg', '.gif', '.ico', '.html', '.eot', '.ttf', '.woff', '.woff2']
      },
      module: []
    },
    module: {
      aliases: {},
      replacements: {}
    }
  }, this.options || {}, 'query' in this ? loaderUtils.getOptions(this) || {} : {}), /#%%%#/g, '!');

  var compile = function compile(template) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : query.compiler;
    var compileSteps = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 2;
    return function () {
      var locals = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
      options = _clientnode["default"].extend(true, {
        filename: template
      }, options);

      var require = function require(request) {
        var nestedLocals = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
        var template = request.replace(/^(.+)\?[^?]+$/, '$1');
        var queryMatch = /^[^?]+\?(.+)$/.exec(request);

        if (queryMatch) {
          var evaluationFunction = function evaluationFunction(request, template, source, compile, locals) {
            return new Function('request', 'template', 'source', 'compile', 'locals', "return ".concat(queryMatch[1]))(request, template, source, compile, locals);
          };

          nestedLocals = _clientnode["default"].extend(true, nestedLocals, evaluationFunction(request, template, source, compile, locals));
        }

        var nestedOptions = _clientnode["default"].copy(options);

        delete nestedOptions.client;
        nestedOptions = _clientnode["default"].extend(true, {
          encoding: _configurator["default"].encoding
        }, nestedOptions, nestedLocals.options || {});
        if (nestedOptions.isString) return compile(template, nestedOptions)(nestedLocals);

        var templateFilePath = _helper["default"].determineModuleFilePath(template, query.module.aliases, query.module.replacements, {
          file: query.extensions.file.internal,
          module: query.extensions.module
        }, query.context, _configurator["default"].path.source.asset.base, _configurator["default"].path.ignore, _configurator["default"].module.directoryNames, _configurator["default"]["package"].main.fileNames, _configurator["default"]["package"].main.propertyNames, _configurator["default"]["package"].aliasPropertyNames, _configurator["default"].encoding);

        if (templateFilePath) {
          if ('query' in _this) _this.addDependency(templateFilePath);
          /*
              NOTE: If there aren't any locals options or variables and
              file doesn't seem to be an ejs template we simply load
              included file content.
          */

          if (queryMatch || templateFilePath.endsWith('.ejs')) return compile(templateFilePath, nestedOptions)(nestedLocals);
          return _fs["default"].readFileSync(templateFilePath, nestedOptions);
        }

        throw new Error("Given template file \"".concat(template, "\" couldn't be resolved."));
      };

      var compressHTML = function compressHTML(content) {
        return query.compress.html ? (0, _htmlMinifier.minify)(content, _clientnode["default"].extend(true, {
          caseSensitive: true,
          collapseInlineTagWhitespace: true,
          collapseWhitespace: true,
          conservativeCollapse: true,
          minifyCSS: true,
          minifyJS: true,
          processScripts: ['text/ng-template', 'text/x-handlebars-template'],
          removeAttributeQuotes: true,
          removeComments: true,
          removeRedundantAttributes: true,
          removeScriptTypeAttributes: true,
          removeStyleLinkTypeAttributes: true,
          sortAttributes: true,
          sortClassName: true,

          /*
              NOTE: Avoids whitespace around placeholder in
              tags.
          */
          trimCustomFragments: true,
          useShortDoctype: true
        }, query.compress.html)) : content;
      };

      var remainingSteps = compileSteps;
      var result = template;
      var isString = options.isString;
      delete options.isString;

      while (remainingSteps > 0) {
        if (typeof result === 'string') {
          var filePath = isString && options.filename || result;
          if (filePath && _path["default"].extname(filePath) === '.js') result = eval('require')(filePath);else {
            if (!isString) {
              var encoding = _configurator["default"].encoding;
              if (typeof options.encoding === 'string') encoding = options.encoding;
              result = _fs["default"].readFileSync(result, {
                encoding: encoding
              });
            }

            if (remainingSteps === 1) result = compressHTML(result);
            result = _ejs["default"].compile(result, options);
          }
        } else result = compressHTML(result(_clientnode["default"].extend(true, {
          configuration: _configurator["default"],
          Helper: _helper["default"],
          include: require,
          require: require,
          Tools: _clientnode["default"]
        }, locals)));

        remainingSteps -= 1;
      }

      if (compileSteps % 2) {
        var code = "module.exports = ".concat(result.toString(), ";");
        var processed = (0, _core.transformSync)(code, {
          ast: false,
          babelrc: false,
          comments: !query.compress.javaScript,
          compact: Boolean(query.compress.javaScript),
          filename: options.filename || 'unknown',
          minified: Boolean(query.compress.javaScript),

          /*
              NOTE: See corresponding import statement.
          plugins: [transformWith],
          */
          presets: query.compress.javaScript ? [[_babelPresetMinify["default"], query.compress.javaScript]] : [],
          sourceMaps: false,
          sourceType: 'script'
        });
        if (processed && typeof processed.code === 'string') code = processed.code;
        return "'use strict';\n".concat(code);
      }

      if (typeof result === 'string') {
        result = result.replace(new RegExp("<script +processing-workaround *" + "(?:= *(?:\" *\"|' *') *)?>([\\s\\S]*?)</ *script *>", 'ig'), '$1').replace(new RegExp("<script +processing(-+)-workaround *" + "(?:= *(?:\" *\"|' *') *)?>([\\s\\S]*?)</ *script *>", 'ig'), '<script processing$1workaround>$2</script>');
        return result;
      }

      return '';
    };
  };

  return compile(source, {
    client: Boolean(query.compileSteps % 2),
    compileDebug: this.debug || false,
    debug: this.debug || false,
    filename: 'query' in this ? loaderUtils.getRemainingRequest(this).replace(/^!/, '') : this.filename || null,
    isString: true
  }, query.compileSteps)(query.locals || {});
}; // region vim modline
// vim: set tabstop=4 shiftwidth=4 expandtab:
// vim: foldmethod=marker foldmarker=region,endregion:
// endregion

//# sourceMappingURL=data:application/json;charset=utf-8;base64,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REosRUFHSSxJQUhKLENBVkMsRUFlRCw0Q0FmQyxDQUFUO0FBaUJBLGVBQU8sTUFBUDtBQUNIOztBQUNELGFBQU8sRUFBUDtBQUNILEtBekwrQjtBQUFBLEdBQWhDOztBQTBMQSxTQUFPLE9BQU8sQ0FDVixNQURVLEVBRVY7QUFDSSxJQUFBLE1BQU0sRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLFlBQU4sR0FBcUIsQ0FBdEIsQ0FEbkI7QUFFSSxJQUFBLFlBQVksRUFBRSxLQUFLLEtBQUwsSUFBYyxLQUZoQztBQUdJLElBQUEsS0FBSyxFQUFFLEtBQUssS0FBTCxJQUFjLEtBSHpCO0FBSUksSUFBQSxRQUFRLEVBQ0osV0FBVyxJQUFYLEdBQ0ksV0FBVyxDQUFDLG1CQUFaLENBQWdDLElBQWhDLEVBQXNDLE9BQXRDLENBQThDLElBQTlDLEVBQW9ELEVBQXBELENBREosR0FFSSxLQUFLLFFBQUwsSUFBaUIsSUFQN0I7QUFRSSxJQUFBLFFBQVEsRUFBRTtBQVJkLEdBRlUsRUFZVixLQUFLLENBQUMsWUFaSSxDQUFQLENBYUwsS0FBSyxDQUFDLE1BQU4sSUFBZ0IsRUFiWCxDQUFQO0FBY0gsQ0FsUUQsQyxDQW1RQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJlanNMb2FkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG4vLyAtKi0gY29kaW5nOiB1dGYtOCAtKi1cbid1c2Ugc3RyaWN0J1xuLyogIVxuICAgIHJlZ2lvbiBoZWFkZXJcbiAgICBDb3B5cmlnaHQgVG9yYmVuIFNpY2tlcnQgKGluZm9bXCJ+YXR+XCJddG9yYmVuLndlYnNpdGUpIDE2LjEyLjIwMTJcblxuICAgIExpY2Vuc2VcbiAgICAtLS0tLS0tXG5cbiAgICBUaGlzIGxpYnJhcnkgd3JpdHRlbiBieSBUb3JiZW4gU2lja2VydCBzdGFuZCB1bmRlciBhIGNyZWF0aXZlIGNvbW1vbnNcbiAgICBuYW1pbmcgMy4wIHVucG9ydGVkIGxpY2Vuc2UuXG4gICAgU2VlIGh0dHBzOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS8zLjAvZGVlZC5kZVxuICAgIGVuZHJlZ2lvblxuKi9cbi8vIHJlZ2lvbiBpbXBvcnRzXG5pbXBvcnQge1xuICAgIEJhYmVsRmlsZVJlc3VsdCwgdHJhbnNmb3JtU3luYyBhcyBiYWJlbFRyYW5zZm9ybVN5bmNcbn0gZnJvbSAnQGJhYmVsL2NvcmUnXG5pbXBvcnQgYmFiZWxNaW5pZnlQcmVzZXQgZnJvbSAnYmFiZWwtcHJlc2V0LW1pbmlmeSdcbi8qXG4gICAgTk9URTogV291bGQgcmVzdWx0IGluIGVycm9yOiBcIlR5cGVFcnJvcjpcbiAgICAuLi93ZWJPcHRpbWl6ZXIvdW5rbm93bjogQ2Fubm90IHJlYWQgcHJvcGVydHlcbiAgICAnY29udGV4dFZhcmlhYmxlcycgb2YgdW5kZWZpbmVkXG5cbiAgICBpbXBvcnQgdHJhbnNmb3JtV2l0aCBmcm9tICdiYWJlbC1wbHVnaW4tdHJhbnNmb3JtLXdpdGgnXG4qL1xuaW1wb3J0IFRvb2xzIGZyb20gJ2NsaWVudG5vZGUnXG5pbXBvcnQgZWpzIGZyb20gJ2VqcydcbmltcG9ydCBmaWxlU3lzdGVtIGZyb20gJ2ZzJ1xuaW1wb3J0IHttaW5pZnkgYXMgbWluaWZ5SFRNTH0gZnJvbSAnaHRtbC1taW5pZmllcidcbmltcG9ydCAqIGFzIGxvYWRlclV0aWxzIGZyb20gJ2xvYWRlci11dGlscydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5cbmltcG9ydCBjb25maWd1cmF0aW9uIGZyb20gJy4vY29uZmlndXJhdG9yJ1xuaW1wb3J0IEhlbHBlciBmcm9tICcuL2hlbHBlcidcbi8vIGVuZHJlZ2lvblxuLy8gcmVnaW9uIHR5cGVzXG50eXBlIFRlbXBsYXRlRnVuY3Rpb24gPSAobG9jYWxzOlJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiBzdHJpbmdcbnR5cGUgQ29tcGlsZXJPcHRpb25zID0ge1xuICAgIGNhY2hlPzpib29sZWFuO1xuICAgIGNsaWVudDpib29sZWFuO1xuICAgIGNvbXBpbGVEZWJ1Zzpib29sZWFuO1xuICAgIGRlYnVnOmJvb2xlYW47XG4gICAgZW5jb2Rpbmc/OnN0cmluZztcbiAgICBmaWxlbmFtZTpzdHJpbmc7XG4gICAgaXNTdHJpbmc6Ym9vbGVhbjtcbn1cbnR5cGUgQ29tcGlsZUZ1bmN0aW9uID0gKFxuICAgIHRlbXBsYXRlOnN0cmluZywgb3B0aW9uczpDb21waWxlck9wdGlvbnMsIGNvbXBpbGVTdGVwcz86bnVtYmVyXG4pID0+IFRlbXBsYXRlRnVuY3Rpb25cbi8vIGVuZHJlZ2lvblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbih0aGlzOmFueSwgc291cmNlOnN0cmluZyk6c3RyaW5nIHtcbiAgICBpZiAoJ2NhY2hhYmxlJyBpbiB0aGlzICYmIHRoaXMuY2FjaGVhYmxlKVxuICAgICAgICB0aGlzLmNhY2hlYWJsZSgpXG4gICAgY29uc3QgcXVlcnk6e1xuICAgICAgICBjb21waWxlcjpDb21waWxlck9wdGlvbnM7XG4gICAgICAgIGNvbXBpbGVTdGVwczogbnVtYmVyO1xuICAgICAgICBjb21wcmVzczp7XG4gICAgICAgICAgICBodG1sOlJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgICAgICAgamF2YVNjcmlwdDpSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgfTtcbiAgICAgICAgY29udGV4dDpzdHJpbmc7XG4gICAgICAgIGV4dGVuc2lvbnM6e1xuICAgICAgICAgICAgZmlsZTp7XG4gICAgICAgICAgICAgICAgZXh0ZXJuYWw6QXJyYXk8c3RyaW5nPjtcbiAgICAgICAgICAgICAgICBpbnRlcm5hbDpBcnJheTxzdHJpbmc+O1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG1vZHVsZTpBcnJheTxzdHJpbmc+O1xuICAgICAgICB9O1xuICAgICAgICBsb2NhbHM/OlJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgICBtb2R1bGU6e1xuICAgICAgICAgICAgYWxpYXNlczpSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICAgICAgICAgICAgcmVwbGFjZW1lbnRzOlJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gICAgICAgIH07XG4gICAgICAgIFtrZXk6c3RyaW5nXTogdW5rbm93bjtcbiAgICB9ID0gVG9vbHMuY29udmVydFN1YnN0cmluZ0luUGxhaW5PYmplY3QoXG4gICAgICAgIFRvb2xzLmV4dGVuZChcbiAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY29tcGlsZVN0ZXBzOiAyLFxuICAgICAgICAgICAgICAgIGNvbXByZXNzOiB7XG4gICAgICAgICAgICAgICAgICAgIGh0bWw6IHt9LFxuICAgICAgICAgICAgICAgICAgICBqYXZhU2NyaXB0OiB7fVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY29udGV4dDogJy4vJyxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIGZpbGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVybmFsOiBbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVybmFsOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJy5qcycsICcuanNvbicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJy5jc3MnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICcuc3ZnJywgJy5wbmcnLCAnLmpwZycsICcuZ2lmJywgJy5pY28nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICcuaHRtbCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJy5lb3QnLCAnLnR0ZicsICcud29mZicsICcud29mZjInXG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZTogW11cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG1vZHVsZToge1xuICAgICAgICAgICAgICAgICAgICBhbGlhc2VzOiB7fSxcbiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZW1lbnRzOiB7fVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMgfHwge30sXG4gICAgICAgICAgICAncXVlcnknIGluIHRoaXMgPyBsb2FkZXJVdGlscy5nZXRPcHRpb25zKHRoaXMpIHx8IHt9IDoge31cbiAgICAgICAgKSxcbiAgICAgICAgLyMlJSUjL2csXG4gICAgICAgICchJ1xuICAgIClcbiAgICBjb25zdCBjb21waWxlOkNvbXBpbGVGdW5jdGlvbiA9IChcbiAgICAgICAgdGVtcGxhdGU6c3RyaW5nLFxuICAgICAgICBvcHRpb25zOkNvbXBpbGVyT3B0aW9ucyA9IHF1ZXJ5LmNvbXBpbGVyLFxuICAgICAgICBjb21waWxlU3RlcHMgPSAyXG4gICAgKTpUZW1wbGF0ZUZ1bmN0aW9uID0+IChsb2NhbHM6UmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7fSk6c3RyaW5nID0+IHtcbiAgICAgICAgb3B0aW9ucyA9IFRvb2xzLmV4dGVuZCh0cnVlLCB7ZmlsZW5hbWU6IHRlbXBsYXRlfSwgb3B0aW9ucylcbiAgICAgICAgY29uc3QgcmVxdWlyZTpGdW5jdGlvbiA9IChcbiAgICAgICAgICAgIHJlcXVlc3Q6c3RyaW5nLCBuZXN0ZWRMb2NhbHM6UmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7fVxuICAgICAgICApOnN0cmluZyA9PiB7XG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZTpzdHJpbmcgPSByZXF1ZXN0LnJlcGxhY2UoL14oLispXFw/W14/XSskLywgJyQxJylcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5TWF0Y2g6QXJyYXk8c3RyaW5nPnxudWxsID0gL15bXj9dK1xcPyguKykkLy5leGVjKHJlcXVlc3QpXG4gICAgICAgICAgICBpZiAocXVlcnlNYXRjaCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGV2YWx1YXRpb25GdW5jdGlvbiA9IChcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdDpzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOnN0cmluZywgc291cmNlOnN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgY29tcGlsZTpDb21waWxlRnVuY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsczpSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICAgICAgICAgICAgICAgICk6UmVjb3JkPHN0cmluZywgdW5rbm93bj4gPT5cbiAgICAgICAgICAgICAgICAgICAgKG5ldyBGdW5jdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1ZXN0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZW1wbGF0ZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc291cmNlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdjb21waWxlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdsb2NhbHMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgYHJldHVybiAke3F1ZXJ5TWF0Y2hbMV19YFxuICAgICAgICAgICAgICAgICAgICApKShyZXF1ZXN0LCB0ZW1wbGF0ZSwgc291cmNlLCBjb21waWxlLCBsb2NhbHMpXG4gICAgICAgICAgICAgICAgbmVzdGVkTG9jYWxzID0gVG9vbHMuZXh0ZW5kKFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBuZXN0ZWRMb2NhbHMsXG4gICAgICAgICAgICAgICAgICAgIGV2YWx1YXRpb25GdW5jdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QsIHRlbXBsYXRlLCBzb3VyY2UsIGNvbXBpbGUsIGxvY2FscykpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgbmVzdGVkT3B0aW9uczpDb21waWxlck9wdGlvbnMgPSBUb29scy5jb3B5KG9wdGlvbnMpXG4gICAgICAgICAgICBkZWxldGUgbmVzdGVkT3B0aW9ucy5jbGllbnRcbiAgICAgICAgICAgIG5lc3RlZE9wdGlvbnMgPSBUb29scy5leHRlbmQoXG4gICAgICAgICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICAgICAgICB7ZW5jb2Rpbmc6IGNvbmZpZ3VyYXRpb24uZW5jb2Rpbmd9LFxuICAgICAgICAgICAgICAgIG5lc3RlZE9wdGlvbnMsXG4gICAgICAgICAgICAgICAgbmVzdGVkTG9jYWxzLm9wdGlvbnMgfHwge31cbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGlmIChuZXN0ZWRPcHRpb25zLmlzU3RyaW5nKVxuICAgICAgICAgICAgICAgIHJldHVybiBjb21waWxlKHRlbXBsYXRlLCBuZXN0ZWRPcHRpb25zKShuZXN0ZWRMb2NhbHMpXG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZUZpbGVQYXRoOm51bGx8c3RyaW5nID0gSGVscGVyLmRldGVybWluZU1vZHVsZUZpbGVQYXRoKFxuICAgICAgICAgICAgICAgIHRlbXBsYXRlLFxuICAgICAgICAgICAgICAgIHF1ZXJ5Lm1vZHVsZS5hbGlhc2VzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5Lm1vZHVsZS5yZXBsYWNlbWVudHMsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBmaWxlOiBxdWVyeS5leHRlbnNpb25zLmZpbGUuaW50ZXJuYWwsXG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZTogcXVlcnkuZXh0ZW5zaW9ucy5tb2R1bGVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHF1ZXJ5LmNvbnRleHQsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wYXRoLnNvdXJjZS5hc3NldC5iYXNlLFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC5pZ25vcmUsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5tb2R1bGUuZGlyZWN0b3J5TmFtZXMsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wYWNrYWdlLm1haW4uZmlsZU5hbWVzLFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGFja2FnZS5tYWluLnByb3BlcnR5TmFtZXMsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wYWNrYWdlLmFsaWFzUHJvcGVydHlOYW1lcyxcbiAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmVuY29kaW5nXG4gICAgICAgICAgICApXG4gICAgICAgICAgICBpZiAodGVtcGxhdGVGaWxlUGF0aCkge1xuICAgICAgICAgICAgICAgIGlmICgncXVlcnknIGluIHRoaXMpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkRGVwZW5kZW5jeSh0ZW1wbGF0ZUZpbGVQYXRoKVxuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgICAgIE5PVEU6IElmIHRoZXJlIGFyZW4ndCBhbnkgbG9jYWxzIG9wdGlvbnMgb3IgdmFyaWFibGVzIGFuZFxuICAgICAgICAgICAgICAgICAgICBmaWxlIGRvZXNuJ3Qgc2VlbSB0byBiZSBhbiBlanMgdGVtcGxhdGUgd2Ugc2ltcGx5IGxvYWRcbiAgICAgICAgICAgICAgICAgICAgaW5jbHVkZWQgZmlsZSBjb250ZW50LlxuICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKHF1ZXJ5TWF0Y2ggfHwgdGVtcGxhdGVGaWxlUGF0aC5lbmRzV2l0aCgnLmVqcycpKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZSh0ZW1wbGF0ZUZpbGVQYXRoLCBuZXN0ZWRPcHRpb25zKShcbiAgICAgICAgICAgICAgICAgICAgICAgIG5lc3RlZExvY2FscylcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlsZVN5c3RlbS5yZWFkRmlsZVN5bmModGVtcGxhdGVGaWxlUGF0aCwgbmVzdGVkT3B0aW9ucykgYXMgdW5rbm93biBhcyBzdHJpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICBgR2l2ZW4gdGVtcGxhdGUgZmlsZSBcIiR7dGVtcGxhdGV9XCIgY291bGRuJ3QgYmUgcmVzb2x2ZWQuYClcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb21wcmVzc0hUTUw6RnVuY3Rpb24gPSAoY29udGVudDpzdHJpbmcpOnN0cmluZyA9PlxuICAgICAgICAgICAgcXVlcnkuY29tcHJlc3MuaHRtbCA/XG4gICAgICAgICAgICAgICAgbWluaWZ5SFRNTChcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCxcbiAgICAgICAgICAgICAgICAgICAgVG9vbHMuZXh0ZW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlU2Vuc2l0aXZlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxhcHNlSW5saW5lVGFnV2hpdGVzcGFjZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsYXBzZVdoaXRlc3BhY2U6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc2VydmF0aXZlQ29sbGFwc2U6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluaWZ5Q1NTOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbmlmeUpTOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NTY3JpcHRzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0L25nLXRlbXBsYXRlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RleHQveC1oYW5kbGViYXJzLXRlbXBsYXRlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQXR0cmlidXRlUXVvdGVzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNvbW1lbnRzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZVJlZHVuZGFudEF0dHJpYnV0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlU2NyaXB0VHlwZUF0dHJpYnV0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlU3R5bGVMaW5rVHlwZUF0dHJpYnV0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ydEF0dHJpYnV0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ydENsYXNzTmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOT1RFOiBBdm9pZHMgd2hpdGVzcGFjZSBhcm91bmQgcGxhY2Vob2xkZXIgaW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFncy5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyaW1DdXN0b21GcmFnbWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlU2hvcnREb2N0eXBlOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkuY29tcHJlc3MuaHRtbFxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKSA6XG4gICAgICAgICAgICAgICAgY29udGVudFxuICAgICAgICBsZXQgcmVtYWluaW5nU3RlcHM6bnVtYmVyID0gY29tcGlsZVN0ZXBzXG4gICAgICAgIGxldCByZXN1bHQ6VGVtcGxhdGVGdW5jdGlvbnxzdHJpbmcgPSB0ZW1wbGF0ZVxuICAgICAgICBjb25zdCBpc1N0cmluZzpib29sZWFuID0gb3B0aW9ucy5pc1N0cmluZ1xuICAgICAgICBkZWxldGUgb3B0aW9ucy5pc1N0cmluZ1xuICAgICAgICB3aGlsZSAocmVtYWluaW5nU3RlcHMgPiAwKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlUGF0aDpzdHJpbmcgPSBpc1N0cmluZyAmJiBvcHRpb25zLmZpbGVuYW1lIHx8IHJlc3VsdFxuICAgICAgICAgICAgICAgIGlmIChmaWxlUGF0aCAmJiBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpID09PSAnLmpzJylcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZXZhbCgncmVxdWlyZScpKGZpbGVQYXRoKVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzU3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZW5jb2Rpbmc6c3RyaW5nID0gY29uZmlndXJhdGlvbi5lbmNvZGluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmVuY29kaW5nID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGluZyA9IG9wdGlvbnMuZW5jb2RpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpbGVTeXN0ZW0ucmVhZEZpbGVTeW5jKHJlc3VsdCwge2VuY29kaW5nfSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nU3RlcHMgPT09IDEpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBjb21wcmVzc0hUTUwocmVzdWx0KVxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBlanMuY29tcGlsZShyZXN1bHQsIG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gY29tcHJlc3NIVE1MKHJlc3VsdChUb29scy5leHRlbmQoXG4gICAgICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHtjb25maWd1cmF0aW9uLCBIZWxwZXIsIGluY2x1ZGU6IHJlcXVpcmUsIHJlcXVpcmUsIFRvb2xzfSxcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxzXG4gICAgICAgICAgICAgICAgKSkpXG4gICAgICAgICAgICByZW1haW5pbmdTdGVwcyAtPSAxXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbXBpbGVTdGVwcyAlIDIpIHtcbiAgICAgICAgICAgIGxldCBjb2RlOnN0cmluZyA9IGBtb2R1bGUuZXhwb3J0cyA9ICR7cmVzdWx0LnRvU3RyaW5nKCl9O2BcbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NlZDpCYWJlbEZpbGVSZXN1bHR8bnVsbCA9IGJhYmVsVHJhbnNmb3JtU3luYyhcbiAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgYXN0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgYmFiZWxyYzogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGNvbW1lbnRzOiAhcXVlcnkuY29tcHJlc3MuamF2YVNjcmlwdCxcbiAgICAgICAgICAgICAgICAgICAgY29tcGFjdDogQm9vbGVhbihxdWVyeS5jb21wcmVzcy5qYXZhU2NyaXB0KSxcbiAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWU6IG9wdGlvbnMuZmlsZW5hbWUgfHwgJ3Vua25vd24nLFxuICAgICAgICAgICAgICAgICAgICBtaW5pZmllZDogQm9vbGVhbihxdWVyeS5jb21wcmVzcy5qYXZhU2NyaXB0KSxcbiAgICAgICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgICAgICAgIE5PVEU6IFNlZSBjb3JyZXNwb25kaW5nIGltcG9ydCBzdGF0ZW1lbnQuXG4gICAgICAgICAgICAgICAgICAgIHBsdWdpbnM6IFt0cmFuc2Zvcm1XaXRoXSxcbiAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgcHJlc2V0czogcXVlcnkuY29tcHJlc3MuamF2YVNjcmlwdCA/XG4gICAgICAgICAgICAgICAgICAgICAgICBbW2JhYmVsTWluaWZ5UHJlc2V0LCBxdWVyeS5jb21wcmVzcy5qYXZhU2NyaXB0XV0gOlxuICAgICAgICAgICAgICAgICAgICAgICAgW10sXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZU1hcHM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBzb3VyY2VUeXBlOiAnc2NyaXB0J1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGlmIChwcm9jZXNzZWQgJiYgdHlwZW9mIHByb2Nlc3NlZC5jb2RlID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgICAgICBjb2RlID0gcHJvY2Vzc2VkLmNvZGVcbiAgICAgICAgICAgIHJldHVybiBgJ3VzZSBzdHJpY3QnO1xcbiR7Y29kZX1gXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHRcbiAgICAgICAgICAgICAgICAucmVwbGFjZShcbiAgICAgICAgICAgICAgICAgICAgbmV3IFJlZ0V4cChcbiAgICAgICAgICAgICAgICAgICAgICAgIGA8c2NyaXB0ICtwcm9jZXNzaW5nLXdvcmthcm91bmQgKmAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYCg/Oj0gKig/OlwiICpcInwnIConKSAqKT8+KFtcXFxcc1xcXFxTXSo/KTwvICpzY3JpcHQgKj5gLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2lnJ1xuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAnJDEnXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKFxuICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKFxuICAgICAgICAgICAgICAgICAgICAgICAgYDxzY3JpcHQgK3Byb2Nlc3NpbmcoLSspLXdvcmthcm91bmQgKmAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYCg/Oj0gKig/OlwiICpcInwnIConKSAqKT8+KFtcXFxcc1xcXFxTXSo/KTwvICpzY3JpcHQgKj5gLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2lnJ1xuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAnPHNjcmlwdCBwcm9jZXNzaW5nJDF3b3JrYXJvdW5kPiQyPC9zY3JpcHQ+J1xuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJydcbiAgICB9XG4gICAgcmV0dXJuIGNvbXBpbGUoXG4gICAgICAgIHNvdXJjZSxcbiAgICAgICAge1xuICAgICAgICAgICAgY2xpZW50OiBCb29sZWFuKHF1ZXJ5LmNvbXBpbGVTdGVwcyAlIDIpLFxuICAgICAgICAgICAgY29tcGlsZURlYnVnOiB0aGlzLmRlYnVnIHx8IGZhbHNlLFxuICAgICAgICAgICAgZGVidWc6IHRoaXMuZGVidWcgfHwgZmFsc2UsXG4gICAgICAgICAgICBmaWxlbmFtZTpcbiAgICAgICAgICAgICAgICAncXVlcnknIGluIHRoaXMgP1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXJVdGlscy5nZXRSZW1haW5pbmdSZXF1ZXN0KHRoaXMpLnJlcGxhY2UoL14hLywgJycpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWxlbmFtZSB8fCBudWxsLFxuICAgICAgICAgICAgaXNTdHJpbmc6IHRydWVcbiAgICAgICAgfSxcbiAgICAgICAgcXVlcnkuY29tcGlsZVN0ZXBzXG4gICAgKShxdWVyeS5sb2NhbHMgfHwge30pXG59XG4vLyByZWdpb24gdmltIG1vZGxpbmVcbi8vIHZpbTogc2V0IHRhYnN0b3A9NCBzaGlmdHdpZHRoPTQgZXhwYW5kdGFiOlxuLy8gdmltOiBmb2xkbWV0aG9kPW1hcmtlciBmb2xkbWFya2VyPXJlZ2lvbixlbmRyZWdpb246XG4vLyBlbmRyZWdpb25cbiJdfQ==